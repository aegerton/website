---
title: Capital Insurance Group Structured XOL 2017-20
author: AAHE
date: '2017-09-25'
slug: capital-insurance-group-xol-2017-20
categories: []
tags: []
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Monte Carlo Simulation in R

### Preamble

R is a language and environment for statistical computing and graphics. R provides a wide variety of statistical (linear and nonlinear modelling, classical statistical tests, time-series analysis, classification, clustering, …) and graphical techniques, and is highly extensible. R is available as Free Software under the terms of the Free Software Foundation’s GNU General Public License in source code form. For more details, please see <https://www.r-project.org/>.

This analysis makes use of the R package fitdistrplus that provides functions for fitting univariate distributions to different types of data (continuous censored or non-censored data and discrete data) and allowing different estimation methods (maximum likelihood, moment matching, quantile matching and maximum goodness-of-fit estimation).  For more details, please see <http://www.jstatsoft.org/v64/i04/>.

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown, please see <http://rmarkdown.rstudio.com>.

```{r,echo=F,warning=FALSE, error=FALSE, message=FALSE}
## R Packages
library(fitdistrplus, quietly=T)
library(tibble, quietly = T)
library(dplyr, quietly = T)
## print("Loss Data",quote = F)


```

### Deal Structure

```{r co2,echo=T}
L<-c(1e6,9e6,36e6,72e6)
GNPI<-c(53.35e6,60e6,66e6)
r<-c(0.10514,0.35)
P<-c(GNPI*r[1])
HUL<-c(0.1,0.2)
lnorm <- c(1.14,1.5)
lambda<-c(1.67,0)
ROE<-3.189300

```

### Monte Carlo Simulation Output

```{r iris,echo=F}
ln <- c(log(exp(lnorm[1])*1e6),1.5)
n <- 10000
iterations<-replicate(n,{
  freq<-(rpois(2,lambda))
  i<-1
  temp<-0
  while (i<=freq[1]){
    sev<-pmin(L[2],pmax(0,(rlnorm(1,ln[1],ln[2]))-L[1]))
    temp<-temp+sev
    i<-i+1}
  min(L[3],(temp+(freq[2]*L[2])))})
agg<-replicate(n,{
  year.loss<-sample(iterations,3,replace=TRUE)
  year.loss[3]<-min(year.loss[3],L[4]-year.loss[1]-year.loss[2])
  year.premium<-(P*(1+(year.loss*0.6/L[2])))
  agg.loss<-sum(year.loss)
  agg.premium<-sum(year.premium)
  c(agg.premium,agg.loss)})
atr <- as.tibble(t(agg/ROE))
colnames(atr)<-c("total.premium","agg.loss")
atr <- mutate(atr,
              HUL.commission = sum(P)*r[2]*HUL[1]/ROE,
              profit = total.premium-agg.loss-HUL.commission,
              margin = pmin(sum(P)*r[2]*(1-HUL[1])/ROE,pmax(0,profit)),
              HUL.profit = margin*HUL[2],
              net.margin = margin-HUL.profit,
              NPV = pmin(net.margin,profit))
atr <- select(atr,total.premium,agg.loss,NPV)
atr.loss <- filter(atr,NPV<0)
atr.profit <- filter(atr,NPV>=0)
summary(atr)
## (((-mean(atr$net.result)/quantile(atr$net.result,0.01))+1)^(1/2.5))-1

df <- c("Average NPV", "Avg NPV / ERD", "Maximum NPV", "Average NPV in Profit Cases", "Minimum NPV", "Probability of Loss", "Average Loss in Loss Cases", "Avg Loss in Loss Cases / Avg Prem", "ERD / Avg Prem", "99th Percentile Loss", "99th Percentile Leverage", "ARC", "Spread on Face Capital", "Total Return on ARC", "Avg Life of ARC (estimated)", "Annual Return on ARC")
df <- data.frame(df)
df$USD <- 0
df$USD[1] <- round(mean(atr$NPV))
df$USD[6] <- round(sum(atr$NPV<0)/n,2)
df$USD[7] <- round(sum(atr.loss$NPV)/sum(atr$NPV<0))
df$USD[2] <- abs(round(df$USD[1]/(df$USD[6]*df$USD[7]),2))
df$USD[3] <- round(max(atr$NPV))
df$USD[5] <- round(min(atr$NPV))
df$USD[10] <- round(quantile(atr$NPV,0.01))
df$USD[4] <- round(sum(atr.profit$NPV)/sum(atr$NPV>=0))
df$USD[8] <- abs(round(df$USD[7]/(mean(atr$total.premium)),2))
df$USD[9] <- abs(round(df$USD[6]*df$USD[7]/(mean(atr$total.premium)),2)) 
df$USD[11] <- round(abs(df$USD[10]/df$USD[1]),2)
df$USD[13] <- 0.01
df$USD[12] <- round(((-df$USD[10]+df$USD[1])*0.5)-df$USD[1]+(df$USD[13]*(max(atr$agg.loss)-mean(atr$total.premium))))
df$USD[14] <- round(df$USD[1]/df$USD[12],2)
df$USD[15] <- 2.5
df$USD[16] <- round((df$USD[14]+1)^(1/df$USD[15])-1,2)
df
## (((-mean(atr$net.result)/quantile(atr$net.result,0.01))+1)^(1/2.5))-1

```

## NPV Plots


```{r euro, echo=FALSE}
plotdist(atr$NPV, demp = T, col="blue", pch=16)
 
```



 

